name: CLD_8_320_10MeV_neutrals_MTL

matmul_precision: high

data:
  # Paths to preprocessed data directories
  train_dir: /share/rcifdata/maxhart/data/cld/prepped/train/
  val_dir: /share/rcifdata/maxhart/data/cld/prepped/val/
  test_dir: /share/rcifdata/maxhart/data/cld/prepped/test/

  # Number of events to include in each set
  num_workers: 8
  num_train: -1
  num_test: 1000
  num_val: 100

  # Minibatch size / number of events used per training step
  batch_size: 4

  # Precision of any float values returned by the dataloader
  input_dtype: float32
  target_dtype: float32

  input_pad_value: 0.0
  target_pad_value: 0.0

  # Minimum pT for a particle to be deemed reconstructve in GeV
  particle_min_pt: 0.01
  particle_max_abs_eta: 4.0

  # Whether to include charged / neutral particles as targets
  include_charged: true
  include_neutral: true

  # Number of query slots / particles to generate per event
  force_pad_sizes:
    particle: &num_particles 320
    pandora: *num_particles
    sitrack: *num_particles

  skip_pad_items: []

  sampling_seed: 42

  # Charged particle cuts based on hit content
  charged_particle_min_num_hits:
    vtxd: 0
    trkr: 0
    sihit: 4

  # Charged particle cuts based on hit content
  charged_particle_max_num_hits:
    vtxd: 12
    trkr: 12
    sihit: 24

  particle_cut_veto_min_num_hits:
    ecal: 32
    hcal: 16

  # Cuts on minimum fraction of particle pT a hit should have
  particle_hit_min_p_ratio:
    vtxd: 0.01
    trkr: 0.01

  # Cuts on maximum deflection between subsequent hits
  particle_hit_deflection_cuts:
    vtxd:
      max_angle: 0.25
      max_angle_xy: -1
      max_angle_rz: -1
      num_passes: 8
    trkr:
      max_angle: 1.0
      max_angle_xy: -1
      max_angle_rz: -1
      num_passes: 12

  # Cuts on maximum distance between subsequent hit
  particle_hit_separation_cuts:
    vtxd:
      max_dist: 0.25
      num_passes: 8
    trkr:
      max_dist: 1.5
      num_passes: 12

  truth_filter_hits: []

  merge_inputs:
    vtxd:
      - vtb
      - vte

    trkr:
      - itb
      - ite
      - otb
      - ote

    sihit:
      - vtb
      - vte
      - itb
      - ite
      - otb
      - ote

    ecal:
      - ecb
      - ece

    hcal:
      - hcb
      - hce
      - hco

    muon:
      - msb
      - mse

  inputs:
    vtxd:
      - type
      - quality
      - pos.x
      - pos.y
      - pos.z
      - pos.s
      - pos.r
      - pos.theta
      - pos.eta
      - pos.phi
      - pos.u
      - pos.v
      - eDep
      - eDepError
      - time
      - u.a
      - u.b
      - v.a
      - v.b
      - du
      - dv

    trkr:
      - type
      - quality
      - pos.x
      - pos.y
      - pos.z
      - pos.s
      - pos.r
      - pos.theta
      - pos.eta
      - pos.phi
      - pos.u
      - pos.v
      - eDep
      - eDepError
      - time
      - u.a
      - u.b
      - v.a
      - v.b
      - du
      - dv

    sihit:
      - type

    ecal:
      - type
      - pos.x
      - pos.y
      - pos.z
      - pos.s
      - pos.r
      - pos.theta
      - pos.eta
      - pos.phi
      - pos.u
      - pos.v
      - energy
      - log_energy
      - energyError
      - time

    hcal:
      - type
      - pos.x
      - pos.y
      - pos.z
      - pos.s
      - pos.r
      - pos.theta
      - pos.eta
      - pos.phi
      - pos.u
      - pos.v
      - energy
      - log_energy
      - energyError
      - time

    muon:
      - type
      - pos.x
      - pos.y
      - pos.z
      - pos.s
      - pos.r
      - pos.theta
      - pos.eta
      - pos.phi
      - pos.u
      - pos.v
      - energy
      - log_energy
      - energyError
      - time

  targets:
    particle:
      - PDG
      - charge
      - time
      - mass
      - vtx.x
      - vtx.y
      - vtx.z
      - vtx.r
      - mom.x
      - mom.y
      - mom.z
      - mom.r
      - mom.eta
      - mom.abs_eta
      - mom.phi
      - mom.theta
      - mom.eta_drad
      - mom.phi_drad
      - mom.rinv
      - mom.qopt
      - spin.x
      - spin.y
      - spin.z
      - colorFlow.a
      - colorFlow.b
      - is_charged
      - is_neutral
      - num_vtxd
      - num_trkr
      - num_ecal
      - num_hcal
      - num_sihit
      - num_muon
      - isolation
      - energy_ecal
      - energy_hcal
      - calib_energy_ecal
      - calib_energy_hcal
      - calib_energy_calo
      - is_neutral_hadron
      - is_charged_hadron
      - is_photon
      - is_electron
      - is_muon
      - is_tau
      - is_neutrino
      - is_other
      - is_primary
      - is_secondary

    particle_vtxd:
      - pos.x
      - pos.y
      - pos.z
      - pos.r
      - pos.theta
      - pos.phi
      - mom.x
      - mom.y
      - mom.z
      - mom.r
      - mom.rinv
      - mom.theta
      - mom.phi

    particle_trkr:
      - pos.x
      - pos.y
      - pos.z
      - pos.r
      - pos.theta
      - pos.phi
      - mom.x
      - mom.y
      - mom.z
      - mom.r
      - mom.rinv
      - mom.theta
      - mom.phi

    particle_ecal:
      - energy
      - energy_frac
      - log_energy

    particle_hcal:
      - energy
      - energy_frac
      - log_energy

    particle_muon:
      - energy

    pandora:
      - PDG
      - charge
      - ref.x
      - ref.y
      - ref.z
      - ref.r
      - mom.x
      - mom.y
      - mom.z
      - mom.r
      - mom.eta
      - mom.abs_eta
      - is_charged
      - is_neutral

    pandora_vtxd: []

    pandora_trkr: []

    pandora_ecal: []

    pandora_hcal: []

    pandora_muon: []

    sitrack:
      - type
      - chi2
      - ndf

    sitrack_vtxd: []

    sitrack_trkr: []

# Training stuff here
trainer:
  max_epochs: 10
  accelerator: gpu
  devices: 1
  precision: 32
  log_every_n_steps: 10
  default_root_dir: logs
  # gradient_clip_val: 0.1
  accumulate_grad_batches: 1
  enable_progress_bar: True

  # Specify loggers here
  logger:
    class_path: lightning.pytorch.loggers.CometLogger
    init_args:
      project_name: cld

  callbacks:
    # - class_path: hepattn.callbacks.Compile
    - class_path: hepattn.callbacks.InferenceTimer
    - class_path: hepattn.callbacks.SaveConfig
    - class_path: hepattn.callbacks.Checkpoint
      init_args:
        monitor: train/loss
        every_n_train_steps: 1000
    - class_path: hepattn.callbacks.PredictionWriter
      init_args:
        write_inputs: false
        write_outputs: true
        write_preds: true
        write_targets: false
        write_losses: false
    - class_path: lightning.pytorch.callbacks.ModelSummary
    - class_path: lightning.pytorch.callbacks.LearningRateMonitor
    - class_path: lightning.pytorch.callbacks.TQDMProgressBar
      init_args:
        refresh_rate: 50

model:
  optimizer: lion

  lrs_config:
    initial: 1e-5
    max: 4e-5
    end: 1e-6
    pct_start: 0.01
    skip_scheduler: false
    weight_decay: 1e-5

  mtl: true

  model:
    class_path: hepattn.models.MaskFormer
    init_args:
      dim: &dim 128
      input_sort_field: pos.phi

      input_nets:
        class_path: torch.nn.ModuleList
        init_args:
          modules:
            - class_path: hepattn.models.InputNet
              init_args:
                input_name: vtxd
                input_dtype: float32
                fields:
                  - pos.x
                  - pos.y
                  - pos.z
                  - pos.s
                  - pos.r
                  - pos.theta
                  - pos.phi
                  - u.a
                  - u.b
                  - v.a
                  - v.b
                  - du
                  - dv
                net:
                  class_path: hepattn.models.Dense
                  init_args:
                    input_size: 13
                    output_size: *dim
                posenc:
                  class_path: hepattn.models.posenc.FourierPositionEncoder
                  init_args:
                    input_name: vtxd
                    dim: *dim
                    fields:
                      - pos.x
                      - pos.y
                      - pos.z

            - class_path: hepattn.models.InputNet
              init_args:
                input_name: trkr
                input_dtype: float32
                fields:
                  - pos.x
                  - pos.y
                  - pos.z
                  - pos.s
                  - pos.r
                  - pos.theta
                  - pos.phi
                  - u.a
                  - u.b
                  - v.a
                  - v.b
                  - du
                  - dv
                net:
                  class_path: hepattn.models.Dense
                  init_args:
                    input_size: 13
                    output_size: *dim
                posenc:
                  class_path: hepattn.models.posenc.FourierPositionEncoder
                  init_args:
                    input_name: trkr
                    dim: *dim
                    fields:
                      - pos.x
                      - pos.y
                      - pos.z

            - class_path: hepattn.models.InputNet
              init_args:
                input_name: ecal
                input_dtype: float32
                fields:
                  - pos.x
                  - pos.y
                  - pos.z
                  - pos.s
                  - pos.r
                  - pos.theta
                  - pos.phi
                  - log_energy
                net:
                  class_path: hepattn.models.Dense
                  init_args:
                    input_size: 8
                    output_size: *dim
                posenc:
                  class_path: hepattn.models.posenc.FourierPositionEncoder
                  init_args:
                    input_name: ecal
                    dim: *dim
                    fields:
                      - pos.x
                      - pos.y
                      - pos.z

            - class_path: hepattn.models.InputNet
              init_args:
                input_name: hcal
                input_dtype: float32
                fields:
                  - pos.x
                  - pos.y
                  - pos.z
                  - pos.s
                  - pos.r
                  - pos.theta
                  - pos.phi
                  - log_energy
                net:
                  class_path: hepattn.models.Dense
                  init_args:
                    input_size: 8
                    output_size: *dim
                posenc:
                  class_path: hepattn.models.posenc.FourierPositionEncoder
                  init_args:
                    input_name: hcal
                    dim: *dim
                    fields:
                      - pos.x
                      - pos.y
                      - pos.z

            - class_path: hepattn.models.InputNet
              init_args:
                input_name: muon
                input_dtype: float32
                fields:
                  - pos.x
                  - pos.y
                  - pos.z
                  - pos.s
                  - pos.r
                  - pos.theta
                  - pos.phi
                net:
                  class_path: hepattn.models.Dense
                  init_args:
                    input_size: 7
                    output_size: *dim
                posenc:
                  class_path: hepattn.models.posenc.FourierPositionEncoder
                  init_args:
                    input_name: muon
                    dim: *dim
                    fields:
                      - pos.x
                      - pos.y
                      - pos.z

      encoder:
        class_path: hepattn.models.Encoder
        init_args:
          num_layers: 4
          dim: *dim
          attn_type: torch
          #window_size: 1024
          #window_wrap: true
          hybrid_norm: true
          value_residual: true
          attn_kwargs:
            num_heads: 8

      decoder:
        num_decoder_layers: 4
        num_queries: *num_particles
        mask_attention: true
        use_query_masks: false
        decoder_layer_config:
          dim: *dim
          hybrid_norm: true
          attn_kwargs:
            num_heads: 8

      matcher:
        class_path: hepattn.models.matcher.Matcher
        init_args:
          default_solver: scipy
          adaptive_solver: false
          parallel_solver: true

      tasks:
        class_path: torch.nn.ModuleList
        init_args:
          modules:
            - class_path: hepattn.models.task.ObjectValidTask
              init_args:
                name: flow_valid
                input_object: query
                output_object: flow
                target_object: particle
                losses:
                  object_bce: 0.1
                costs:
                  object_bce: 1.0
                dim: *dim
                null_weight: 1.0
                mask_queries: false
                has_intermediate_loss: False

            - class_path: hepattn.models.task.ObjectHitMaskTask
              init_args:
                name: flow_vtxd_assignment
                input_hit: vtxd
                input_object: query
                output_object: flow
                target_object: particle
                has_intermediate_loss: False
                losses:
                  mask_bce: 0.25
                  mask_dice: 0.75
                  #mask_focal: 1.0
                costs:
                  #mask_bce: 1.0
                  mask_dice: 1.0
                  #mask_focal: 1.0
                dim: *dim
                null_weight: 1.0

            - class_path: hepattn.models.task.ObjectHitMaskTask
              init_args:
                name: flow_trkr_assignment
                input_hit: trkr
                input_object: query
                output_object: flow
                target_object: particle
                has_intermediate_loss: False
                losses:
                  mask_bce: 0.25
                  mask_dice: 0.75
                  #mask_focal: 1.0
                costs:
                  #mask_bce: 1.0
                  mask_dice: 1.0
                  #mask_focal: 1.0
                dim: *dim
                null_weight: 1.0

            - class_path: hepattn.models.task.ObjectHitMaskTask
              init_args:
                name: flow_ecal_assignment
                input_hit: ecal
                input_object: query
                output_object: flow
                target_object: particle
                target_field: valid
                has_intermediate_loss: False
                losses:
                  mask_bce: 0.25
                  mask_dice: 0.75
                  #mask_focal: 1.0
                costs:
                  #mask_bce: 1.0
                  mask_dice: 1.0
                  #mask_focal: 1.0
                dim: *dim
                null_weight: 1.0

            - class_path: hepattn.models.task.ObjectHitMaskTask
              init_args:
                name: flow_hcal_assignment
                input_hit: hcal
                input_object: query
                output_object: flow
                target_object: particle
                target_field: valid
                has_intermediate_loss: False
                losses:
                  mask_bce: 0.25
                  mask_dice: 0.75
                  #mask_focal: 1.0
                costs:
                  #mask_bce: 1.0
                  mask_dice: 1.0
                  #mask_focal: 1.0
                dim: *dim
                null_weight: 1.0

            - class_path: hepattn.models.task.ObjectHitMaskTask
              init_args:
                name: flow_muon_assignment
                input_hit: muon
                input_object: query
                output_object: flow
                target_object: particle
                target_field: valid
                has_intermediate_loss: False
                losses:
                  mask_bce: 0.25
                  mask_dice: 0.75
                  #mask_focal: 1.0
                costs:
                  #mask_bce: 1.0
                  mask_dice: 1.0
                  #mask_focal: 1.0
                dim: *dim
                null_weight: 1.0
